# Подход к работе с распределенными данными

## Контекст:

Мы выделили 6 сервисов, каждый из которых должен иметь свое хранилище, эти сервисы находятся в рамках одного Process Unit. Данные, как и запросы пользователей, должны быть распределены географически. Также мы должны как-то обрабатывать ситуации, когда пользователь переходит из одной зоны в другую, причем для жителей приграничных зон между регионами это переключение может происходить несколько раз в день. Также одни данные чаще считываются, другие записываются, одни данные нужны часто, другие редко.

Можно хранить полную копию данных для каждого Process Unit, но тогда мы потеряем все приемущества выбранного подхода. Можно обращаться к данным других Process Unit, но это также лишит систему всех приемуществ, к которым мы стремимся. Можно хранить только тот набор данных, что относится к Process Unit, а недостающие данные реплицировать "по требованию". 

## Решение

Каждый из выделенных сервисов имеет локальное реляционное хранилище. Часть данных поддерживается в одинаковом состоянии во всех Process Unit посредством репликации, это - все данные сервиса Training, типы метрик, списки видов спорта. Остальные данные разделены географически. 

Ряд данных реплицируется в In-Memory-Data-Grid, а именно: данные сервиса Training, типы метрик, списки видов спорта, выданные авторизационные токены.

При этом каждый Process Unit имеет свой уникальный идентификатор, который возвращается пользователю при авторизации, 
а затем последний передает его при каждом запросе (зашитым в JWT токене или в заголовке). В случае, если пользователь попадает на другой Process Unit, то это будет видно по несовпадающему идентификатору и запрос будет передан предыдущему юниту (если нет уверенности, что произошел его отказ) и данные будут асинхронно отреплицированы. Когда это произойдет, запросы пользователя будут перенаправлены на новый юнит.

## Статус:

принято

## Последствия:

1. Удастся уменьшить количество данных, хранимых каждым Process Unit и повысить среднюю скорость работы с ними.
2. Удастся повысить скорость работы с теми данными, что используются для тренировок (тот раздел системы, что должен работать наиболее быстро) и чистично аутентификации за счет переноса их в оперативную память.
3. Удастся решить проблему смены Process Unit во время использования пользователем приложения.
4. Подход с перенаправлением запросов на предыдущий юнит может привести к тому, что в случае отказа последнего мы все таки не сможем ни обработать запросы, ни отреплицировать данные.
5. Репликация данных должна происходить очень быстро, объем данных должет быть большим, это создает дополнительные трудности в реализации.
6. Описанное решение достаточно сложно и потребует много времени на разработку.